<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>L√†m b√†i</title>

  <style>
  :root {
    --bg: #f1f5f9;
    --card: #ffffff;
    --text: #0f172a;
    --primary: #2563eb;
    --success: #16a34a;
    --danger: #dc2626;
    --warning: #f59e0b;
    --info: #0ea5e9;
    --shadow: rgba(0, 0, 0, 0.1);
  }

    body.dark {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #ffffff;
      --shadow: rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: 0.3s ease;
    }

    .quiz-container {
      display: flex;
      min-height: 100vh;
      gap: 20px;
      padding: 20px;
    }

    /* MAIN */
    .main {
      flex: 3;
      background: var(--card);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 25px var(--shadow);
    }

    /* SIDEBAR */
    .sidebar {
      flex: 1;
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 25px var(--shadow);
    }

    /* C√¢u h·ªèi */
    #questionText {
      margin-bottom: 20px;
    }

    .option {
      background: var(--bg);
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
      border: 1px solid transparent;
    }

    .option:hover {
      transform: translateY(-2px);
      border: 1px solid var(--primary);
    }

    .correct {
      background: var(--success) !important;
      color: white;
    }

    .wrong {
      background: var(--danger) !important;
      color: white;
    }

    .nav-buttons {
      margin-top: 20px;
    }

    button {
      margin: 4px;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
      transition: 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }

    .btn-prev { background: #64748b; }
    .btn-next { background: var(--primary); }
    .btn-finish { background: var(--warning); }
    .btn-home { background: var(--info); }

    #timer {
      margin-bottom: 20px;
      font-weight: bold;
    }

    .result-box {
      margin-top: 20px;
      padding: 20px;
      background: var(--bg);
      border-radius: 14px;
      box-shadow: 0 4px 12px var(--shadow);
    }

    /* Theme toggle */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--card);
      border: none;
      padding: 8px 12px;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 10px var(--shadow);
    }

    /* Responsive */
    @media (max-width: 900px) {
      .quiz-container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<div class="quiz-container">
  <div class="main">
    <h2 id="questionTitle"></h2>
    <p id="questionText"></p>
    <div id="options"></div>

    <div class="nav-buttons">
      <button class="btn-prev" onclick="prevQuestion()">‚¨Ö Quay l·∫°i</button>
      <button class="btn-next" onclick="nextQuestion()">Ti·∫øp t·ª•c ‚û°</button>
      <button class="btn-finish" onclick="finishExam()">K·∫øt th√∫c b√†i</button>
      <button class="btn-home" onclick="goHome()">Trang ch·ªß</button>
    </div>

    <div id="result"></div>
  </div>

  <div class="sidebar">
    <div id="timer"></div>
    <div id="navigator"></div>
    <button onclick="retryWrong()">L√†m l·∫°i c√¢u sai</button>
    <button ondblclick="shuffleQuestions()">üîÄ X√°o tr·ªôn c√¢u h·ªèi</button>
    <button onclick="restoreOriginal()">üìò Tr·ªü v·ªÅ ƒë·ªÅ g·ªëc</button>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const examId = urlParams.get("exam");

  const storedExam = JSON.parse(localStorage.getItem(examId));

  if (!storedExam) {
    alert("Kh√¥ng t√¨m th·∫•y ƒë·ªÅ!");
    window.location.href = "index.html";
  }

  let questions = storedExam.questions;
  let originalQuestions = [...storedExam.questions];
  let current = 0;
  let answers = {};
  let time = 0;
  let finished = false;

  const questionTitle = document.getElementById("questionTitle");
  const questionText = document.getElementById("questionText");
  const optionsDiv = document.getElementById("options");
  const navigatorDiv = document.getElementById("navigator");
  const timerDiv = document.getElementById("timer");
  const resultDiv = document.getElementById("result");

  setInterval(() => {
    time++;
    timerDiv.innerText = "Th·ªùi gian: " + time + "s";
  }, 1000);


  /* ===== Dark Mode ===== */
function toggleTheme() {
    document.body.classList.toggle("dark");

    const btn = document.querySelector(".theme-toggle");

    if (document.body.classList.contains("dark")) {
      btn.innerText = "‚òÄ";
      localStorage.setItem("theme", "dark");
    } else {
      btn.innerText = "üåô";
      localStorage.setItem("theme", "light");
    }
  }

  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark");
    document.querySelector(".theme-toggle").innerText = "‚òÄ";
  }

  function renderQuestion() {
    const q = questions[current];

    if (!q) return;

    questionTitle.innerText = "C√¢u " + (current + 1);
    questionText.innerText = q.text;

    optionsDiv.innerHTML = "";

    Object.entries(q.options).forEach(([key, value]) => {
      const btn = document.createElement("div");
      btn.innerText = key + ". " + value;
      btn.className = "option";

      btn.onclick = () => selectAnswer(key);

      if (answers[current]) {
        if (key === q.correct) {
          btn.classList.add("correct");
        } else if (answers[current] === key) {
          btn.classList.add("wrong");
        }
      }

      optionsDiv.appendChild(btn);
    });

    renderNavigator();
  }

  function selectAnswer(key) {
  if (finished) return;

  answers[current] = key;
  renderQuestion();

  const answeredCount = Object.keys(answers).length;

  if (answeredCount === questions.length) {
    setTimeout(() => {
      finishExam();
    }, 500);
    return;
  }

  setTimeout(() => {
    if (current < questions.length - 1) {
      current++;
      renderQuestion();
    }
  }, 400);
  }

  function nextQuestion() {
    if (current < questions.length - 1) {
      current++;
      renderQuestion();
    }
  }

  function prevQuestion() {
    if (current > 0) {
      current--;
      renderQuestion();
    }
  }

  function renderNavigator() {
    navigatorDiv.innerHTML = "";

    questions.forEach((_, i) => {
      const btn = document.createElement("button");
      btn.innerText = i + 1;

      if (answers[i]) {
        btn.style.background =
          answers[i] === questions[i].correct
            ? "green"
            : "red";
      }

      btn.onclick = () => {
        current = i;
        renderQuestion();
      };

      navigatorDiv.appendChild(btn);
    });
  }

  function finishExam() {
  finished = true;

  let correct = 0;
  let wrong = 0;
  let unanswered = 0;

  questions.forEach((q, i) => {
    if (!answers[i]) {
      unanswered++;
    } else if (answers[i] === q.correct) {
      correct++;
    } else {
      wrong++;
    }
  });

  const percent = ((correct / questions.length) * 100).toFixed(1);

  resultDiv.innerHTML = `
    <div class="result-box">
      <h3>üìä K·∫æT QU·∫¢ B√ÄI THI</h3>
      <p>‚úÖ S·ªë c√¢u ƒë√∫ng: <strong>${correct}</strong></p>
      <p>‚ùå S·ªë c√¢u sai: <strong>${wrong}</strong></p>
      <p>‚ö†Ô∏è Ch∆∞a l√†m: <strong>${unanswered}</strong></p>
      <p>üéØ T·ª∑ l·ªá ƒë√∫ng: <strong>${percent}%</strong></p>
      <p>‚è± Th·ªùi gian l√†m b√†i: <strong>${time}s</strong></p>

      <button onclick="redoWrong()" style="background:#f97316">
        üîÅ L√†m l·∫°i c√¢u sai
      </button>

      <button onclick="restartFullExam()" style="background:#ef4444">
        üîÑ L√†m l·∫°i to√†n b·ªô b√†i
      </button>
    </div>
  `;
  }
  function continueExam() {
  finished = false;
  resultDiv.innerHTML = "";

  for (let i = 0; i < questions.length; i++) {
    if (!answers[i]) {
      current = i;
      renderQuestion();
      return;
    }
  }

  alert("B·∫°n ƒë√£ l√†m h·∫øt t·∫•t c·∫£ c√¢u h·ªèi!");
  }

  function restartExam() {
  answers = {};
  current = 0;
  time = 0;
  resultDiv.innerHTML = "";
  renderQuestion();
  }

  function retryWrong() {
    questions = questions.filter(
      (_, i) => answers[i] !== storedExam.questions[i].correct
    );

    answers = {};
    current = 0;
    resultDiv.innerHTML = "";
    renderQuestion();
  }

  function goHome() {
    window.location.href = "index.html";
  }

  function redoWrong() {
  finished = false;

  questions = originalQuestions.filter((q, i) => {
    return answers[i] !== q.correct;
  });

  answers = {};
  current = 0;
  resultDiv.innerHTML = "";

  if (questions.length === 0) {
    alert("Kh√¥ng c√≥ c√¢u sai ƒë·ªÉ l√†m l·∫°i üéâ");
    return;
  }

  renderQuestion();
}

  function restartFullExam() {
  finished = false;
  questions = [...originalQuestions];
  answers = {};
  current = 0;
  time = 0;
  resultDiv.innerHTML = "";

  renderQuestion();
  }

  function shuffleQuestions() {
  if (finished) {
    alert("Kh√¥ng th·ªÉ x√°o tr·ªôn khi ƒë√£ k·∫øt th√∫c b√†i!");
    return;
  }

  // Thu·∫≠t to√°n Fisher-Yates shuffle
  for (let i = questions.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [questions[i], questions[j]] = [questions[j], questions[i]];
  }

  current = 0;
  answers = {};
  resultDiv.innerHTML = "";

  renderQuestion();

  alert("ƒê√£ x√°o tr·ªôn c√¢u h·ªèi üîÄ");
  }

  function restoreOriginal() {
    if (finished) {
      alert("Kh√¥ng th·ªÉ ƒë·ªïi ƒë·ªÅ khi ƒë√£ k·∫øt th√∫c!");
      return;
    }

    questions = [...originalQuestions];
    answers = {};
    current = 0;
    resultDiv.innerHTML = "";

    renderQuestion();

    alert("ƒê√£ kh√¥i ph·ª•c ƒë·ªÅ g·ªëc üìò");
  }


  renderQuestion();
</script>

</body>
</html>